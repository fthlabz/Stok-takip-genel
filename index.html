<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QR PRO V11 (ÅžEFFAF VÄ°ZÃ–R)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        body { background-color: #0f172a; color: white; font-family: 'Segoe UI', sans-serif; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; touch-action: manipulation; }
        .hidden { display: none !important; }
        .btn-press:active { transform: scale(0.96); transition: 0.1s; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* ÅžEFFAF MASKELEME EFEKTÄ° */
        .scanner-mask {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); /* Arka planÄ± karart */
            -webkit-mask-image: radial-gradient(rect 150px 150px at center, transparent 40%, black 100%);
            mask-image: radial-gradient(rect 150px 150px at center, transparent 40%, black 100%);
            /* Daha basit bir yÃ¶ntem: CSS Clip-path veya Border ile pencere aÃ§ma */
            display: flex; align-items: center; justify-content: center;
        }
        
        /* OrtasÄ± delik kare oluÅŸturma (En garanti yÃ¶ntem) */
        .scan-window {
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.7); /* EtrafÄ± karart */
            border: 2px solid rgba(16, 185, 129, 0.5); /* Hafif yeÅŸil sÄ±nÄ±r */
            border-radius: 20px;
            position: relative;
            background: transparent !important; /* Ä°Ã‡Ä° TAMAMEN ÅžEFFAF */
            width: 250px; height: 250px;
            z-index: 10;
        }

        /* KÃ¶ÅŸe Ã§izgileri (VizÃ¶r) */
        .corner { position: absolute; width: 30px; height: 30px; border-color: #10b981; border-style: solid; border-width: 4px; }
        .tl { top: -2px; left: -2px; border-right: 0; border-bottom: 0; border-top-left-radius: 20px; }
        .tr { top: -2px; right: -2px; border-left: 0; border-bottom: 0; border-top-right-radius: 20px; }
        .bl { bottom: -2px; left: -2px; border-right: 0; border-top: 0; border-bottom-left-radius: 20px; }
        .br { bottom: -2px; right: -2px; border-left: 0; border-top: 0; border-bottom-right-radius: 20px; }

        /* Tarama Ã‡izgisi Animasyonu */
        .scan-line {
            width: 100%; height: 2px; background: #10b981;
            box-shadow: 0 0 10px #10b981;
            position: absolute; top: 0;
            animation: scanMove 2s infinite linear;
            opacity: 0.7;
        }
        @keyframes scanMove { 0% { top: 0; opacity: 0; } 20% { opacity: 1; } 90% { opacity: 1; } 100% { top: 100%; opacity: 0; } }

        /* Video elementinin tam oturmasÄ± iÃ§in */
        #reader video { object-fit: cover; width: 100% !important; height: 100% !important; border-radius: 12px; }
    </style>
</head>
<body>

    <div id="login-screen" class="fixed inset-0 bg-slate-900 z-[9999] flex flex-col items-center justify-center p-6">
        <div class="bg-slate-800 p-8 rounded-2xl border border-slate-700 w-full max-w-sm text-center shadow-2xl">
            <div class="w-20 h-20 bg-indigo-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-lg shadow-indigo-500/50">
                <i class="fa-solid fa-qrcode text-3xl text-white"></i>
            </div>
            <h2 class="text-2xl font-bold text-white mb-2">QR PRO V11</h2>
            <input type="text" id="staff-name" placeholder="KULLANICI ADI" class="w-full bg-slate-950 text-white text-center text-xl font-bold py-4 rounded-xl border-2 border-slate-600 focus:border-indigo-500 outline-none mb-4 uppercase tracking-widest">
            <button onclick="login()" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-4 rounded-xl text-lg shadow-lg btn-press">GÄ°RÄ°Åž YAP</button>
        </div>
    </div>

    <div id="app-content" class="flex flex-col h-full hidden">
        
        <header class="bg-slate-800 p-3 shadow-md border-b border-slate-700 flex justify-between items-center shrink-0 z-20">
            <div>
                <h1 class="font-bold text-gray-100 text-sm">SATIÅž EKRANI</h1>
                <div id="active-staff-display" class="text-[10px] text-emerald-400 font-mono">...</div>
            </div>
             <button onclick="openAccounting()" class="bg-slate-700 hover:bg-slate-600 px-3 py-2 rounded-lg text-xs font-bold text-slate-300 border border-slate-600 btn-press flex items-center gap-2">
                <i class="fa-solid fa-file-invoice"></i> MUHASEBE
            </button>
        </header>

        <div id="status-box" class="absolute top-20 left-1/2 transform -translate-x-1/2 bg-emerald-600 px-6 py-3 rounded-full text-sm font-bold text-white z-50 transition-all duration-300 opacity-0 translate-y-[-20px] shadow-xl flex items-center gap-2 w-max">
            <i class="fa-solid fa-check"></i> <span id="status-text">Ä°ÅŸlem Tamam</span>
        </div>

        <div class="flex-1 overflow-y-auto bg-slate-900 p-4" id="sales-area">
            <div id="empty-state" class="flex flex-col items-center justify-center h-full text-slate-600 opacity-50">
                <i class="fa-solid fa-qrcode text-6xl mb-4"></i>
                <p>QR Okutun...</p>
            </div>
            <div id="cart-list" class="space-y-2 hidden"></div>
        </div>

        <div class="bg-slate-800 p-4 rounded-t-3xl border-t border-slate-700 shadow-2xl z-30 shrink-0">
            
            <div class="flex gap-3 mb-4 items-center">
                <button onclick="openCameraOneShot()" id="cam-btn" class="flex-1 bg-indigo-600 text-white py-4 rounded-xl btn-press text-lg font-bold shadow-lg flex items-center justify-center gap-2">
                    <i class="fa-solid fa-camera text-2xl"></i> <span>QR TARA</span>
                </button>
                <button onclick="toggleManualInput()" class="bg-slate-700 text-white w-16 h-16 rounded-xl btn-press flex items-center justify-center border border-slate-600">
                    <i class="fa-solid fa-keyboard text-xl"></i>
                </button>
            </div>

            <div id="manual-input-box" class="hidden mb-4 flex gap-2">
                <input type="text" id="manual-qr-input" placeholder="QR Kodunu Yaz..." class="flex-1 bg-slate-950 border border-slate-600 rounded-xl px-4 py-3 text-white outline-none font-mono">
                <button onclick="manualProcess()" class="bg-emerald-600 text-white px-4 rounded-xl font-bold">EKLE</button>
            </div>

            <div id="camera-box" class="hidden mb-4 rounded-xl overflow-hidden h-72 bg-black relative border-2 border-indigo-500">
                <div id="reader" class="w-full h-full"></div>
                
                <div class="absolute inset-0 flex items-center justify-center overflow-hidden pointer-events-none">
                    <div class="scan-window">
                        <div class="corner tl"></div><div class="corner tr"></div>
                        <div class="corner bl"></div><div class="corner br"></div>
                        <div class="scan-line"></div>
                    </div>
                </div>

                <button onclick="closeCamera()" class="absolute top-4 right-4 bg-red-600 text-white w-10 h-10 rounded-full z-20 font-bold shadow-lg flex items-center justify-center hover:bg-red-500"><i class="fa-solid fa-xmark"></i></button>
            </div>

            <div class="flex flex-col gap-2 border-t border-slate-700 pt-3">
                <div class="flex justify-between items-end mb-2">
                     <div class="text-xs text-slate-400">GÃœNLÃœK TOPLAM</div>
                     <div id="cart-total" class="text-3xl font-bold text-emerald-400">0.00 â‚º</div>
                </div>
                <div class="flex gap-2">
                    <button onclick="copyMySales()" class="bg-slate-600 text-white px-4 py-4 rounded-2xl font-bold flex-1 btn-press text-sm"><i class="fa-solid fa-copy mr-1"></i> LÄ°STEM</button>
                    <button onclick="completeSale()" id="finish-btn" class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-4 rounded-2xl font-bold shadow-lg disabled:opacity-50 disabled:grayscale flex-[2] btn-press" disabled>SATIÅžI TAMAMLA</button>
                </div>
            </div>
        </div>

        <div id="new-product-modal" class="fixed inset-0 bg-black/95 z-[100] hidden flex flex-col justify-center p-6 backdrop-blur-sm">
            <div class="bg-slate-800 p-6 rounded-3xl border border-slate-600 shadow-2xl relative">
                <button onclick="closeNewProductModal()" class="absolute top-4 right-4 text-slate-400 hover:text-white"><i class="fa-solid fa-xmark text-2xl"></i></button>
                
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-amber-600/20 rounded-full flex items-center justify-center mx-auto mb-3">
                        <i class="fa-solid fa-qrcode text-3xl text-amber-500"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-white">YENÄ° ÃœRÃœN</h2>
                    <p class="text-slate-400 text-xs mt-1">Bu QR kodu tanÄ±mla.</p>
                </div>

                <div class="space-y-4">
                    <div class="bg-slate-900 p-3 rounded-xl border border-slate-700">
                        <label class="text-[10px] text-slate-500 uppercase font-bold block">QR ID</label>
                        <input type="text" id="modal-code" class="w-full bg-transparent text-emerald-400 font-mono text-sm break-all outline-none" readonly>
                    </div>

                    <input type="text" id="modal-name" class="w-full bg-slate-950 text-white p-4 rounded-xl border border-slate-600 focus:border-indigo-500 outline-none font-bold text-lg placeholder-slate-700" placeholder="ÃœrÃ¼n AdÄ±">

                    <div class="grid grid-cols-2 gap-4">
                        <input type="number" id="modal-price" class="w-full bg-slate-950 text-emerald-400 p-4 rounded-xl border border-slate-600 focus:border-emerald-500 outline-none font-bold text-xl placeholder-slate-700" placeholder="Fiyat">
                        <input type="number" id="modal-stock" class="w-full bg-slate-950 text-orange-400 p-4 rounded-xl border border-slate-600 focus:border-orange-500 outline-none font-bold text-xl placeholder-slate-700" placeholder="Stok">
                    </div>
                </div>

                <button onclick="saveNewProduct()" class="w-full mt-8 bg-emerald-600 hover:bg-emerald-500 text-white py-4 rounded-xl font-bold text-lg shadow-lg shadow-emerald-600/20 btn-press">
                    KAYDET VE EKLE
                </button>
            </div>
        </div>

        <div id="accounting-modal" class="fixed inset-0 bg-slate-900 z-[100] hidden flex flex-col">
            <div class="bg-slate-800 p-4 border-b border-slate-700 flex justify-between items-center">
                <h2 class="font-bold text-white text-lg">GÃ¼nlÃ¼k Rapor</h2>
                <button onclick="closeAccounting()" class="bg-slate-700 w-10 h-10 rounded-full text-white"><i class="fa-solid fa-xmark"></i></button>
            </div>
            
            <div class="flex-1 overflow-auto p-4" id="accounting-table-area">
                <table class="w-full text-left text-sm text-slate-300">
                    <thead class="text-slate-500 uppercase font-bold border-b border-slate-700"><tr><th class="pb-2">Saat</th><th class="pb-2">Per.</th><th class="pb-2">ÃœrÃ¼n</th><th class="pb-2 text-right">Tutar</th></tr></thead>
                    <tbody id="accounting-body" class="divide-y divide-slate-800"></tbody>
                </table>
            </div>

            <div class="p-4 bg-slate-800 border-t border-slate-700 space-y-2">
                 <div class="flex gap-2">
                    <button onclick="printReport()" class="flex-1 bg-slate-700 py-3 rounded-xl font-bold text-white text-sm">YAZDIR</button>
                    <button onclick="copyReport()" class="flex-1 bg-slate-700 py-3 rounded-xl font-bold text-white text-sm">KOPYALA</button>
                </div>
                <button onclick="resetDailyData()" class="w-full bg-rose-700 hover:bg-rose-600 py-4 rounded-xl font-bold text-white shadow-lg btn-press flex items-center justify-center gap-2">
                    <i class="fa-solid fa-trash-can"></i> GÃœN SONU (SIFIRLA)
                </button>
            </div>
        </div>

    </div>

    <script>
        // --- âš™ï¸ TOKEN AYARLARI ---
        const token_part_1 = "ghp_"; 
        const token_part_2 = "cXub3CuFhcdHtGbKgyQkvCKj57AUos0kNIIW"; 

        const CONFIG = {
            USER: "fthlabz", 
            REPO: "Stok-takip-genel", 
            FILE_STOK: "genel_stok.json",
            FILE_MUHASEBE: "muhasebe_arsiv.json",
            TOKEN: token_part_1 + token_part_2
        };

        let productDB = {}; 
        let cart = [];
        let currentUser = "";
        let scanner = null;
        let shaStok = null;

        function login() {
            const val = document.getElementById('staff-name').value.trim().toUpperCase();
            if(!val) return alert("KullanÄ±cÄ± adÄ± giriniz!");
            currentUser = val;
            document.getElementById('active-staff-display').innerText = "Kasiyer: " + currentUser;
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-content').classList.remove('hidden');
            loadStockData();
        }

        async function loadStockData() {
            try {
                const url = `https://api.github.com/repos/${CONFIG.USER}/${CONFIG.REPO}/contents/${CONFIG.FILE_STOK}`;
                const res = await fetch(url, { headers: { 'Authorization': `token ${CONFIG.TOKEN}` }, cache: "no-store" });
                if(res.status === 404) {
                    productDB = {}; saveToGithub(CONFIG.FILE_STOK, {}, null, "Init");
                } else if(res.ok) {
                    const data = await res.json();
                    shaStok = data.sha;
                    productDB = JSON.parse(decodeURIComponent(escape(window.atob(data.content))));
                } else {
                    alert("Veri Ã§ekilemedi. BaÄŸlantÄ± hatasÄ±.");
                }
            } catch(e) { console.error(e); }
        }

        // --- GELÄ°ÅžMÄ°Åž KAMERA AYARLARI ---
        function openCameraOneShot() {
            const box = document.getElementById('camera-box');
            document.getElementById('manual-input-box').classList.add('hidden');
            box.classList.remove('hidden');
            
            if(scanner) { scanner.clear(); }
            scanner = new Html5Qrcode("reader");
            
            // Tam ekran dolduran video ayarÄ±
            const config = { 
                fps: 10, 
                qrbox: { width: 250, height: 250 }, // Kare tarama alanÄ±
                aspectRatio: 1.0,
                formatsToSupport: [ Html5QrcodeSupportedFormats.QR_CODE ] 
            };

            scanner.start({ facingMode: "environment" }, config, 
                (decodedText) => {
                    scanner.stop().then(() => { scanner.clear(); box.classList.add('hidden'); });
                    processQR(decodedText);
                },
                (err) => {}
            ).catch(err => { alert("Kamera hatasÄ±: " + err); box.classList.add('hidden'); });
        }

        function closeCamera() {
            if(scanner) scanner.stop().then(()=>scanner.clear());
            document.getElementById('camera-box').classList.add('hidden');
        }

        function toggleManualInput() {
            const box = document.getElementById('manual-input-box');
            if(box.classList.contains('hidden')) {
                box.classList.remove('hidden');
                document.getElementById('camera-box').classList.add('hidden');
                document.getElementById('manual-qr-input').focus();
            } else {
                box.classList.add('hidden');
            }
        }

        function manualProcess() {
            const code = document.getElementById('manual-qr-input').value;
            if(!code) return;
            processQR(code);
            document.getElementById('manual-qr-input').value = "";
        }

        function processQR(code) {
            if(productDB[code]) { addToCart(code); } 
            else { openNewProductModal(code); }
        }

        function addToCart(code) {
            const p = productDB[code];
            if(p.stock <= 0) showStatus("âš ï¸ Stok Bitti!", true);
            cart.push({
                code: code,
                name: p.name,
                price: p.price,
                staff: currentUser,
                date: new Date().toLocaleTimeString('tr-TR', {hour: '2-digit', minute:'2-digit'})
            });
            renderCart();
            showStatus(p.name + " Eklendi", false);
        }

        function renderCart() {
            const list = document.getElementById('cart-list');
            const empty = document.getElementById('empty-state');
            const totalEl = document.getElementById('cart-total');
            const btn = document.getElementById('finish-btn');
            list.innerHTML = ""; let total = 0;
            if(cart.length === 0) {
                list.classList.add('hidden'); empty.classList.remove('hidden');
                btn.disabled = true; totalEl.innerText = "0.00 â‚º";
            } else {
                list.classList.remove('hidden'); empty.classList.add('hidden');
                btn.disabled = false;
                [...cart].reverse().forEach((item, i) => {
                    total += parseFloat(item.price);
                    list.innerHTML += `<div class="bg-slate-800 p-3 rounded-xl border border-slate-700 flex justify-between items-center mb-2"><div><div class="text-[10px] text-slate-400 font-bold">${item.date} - ${item.staff}</div><div class="font-bold text-white text-sm">${item.name}</div></div><div class="text-right"><div class="text-emerald-400 font-bold">${parseFloat(item.price).toFixed(2)}</div><button onclick="cart.splice(${cart.length - 1 - i},1); renderCart()" class="text-rose-500 text-xs mt-1 p-1">SÄ°L</button></div></div>`;
                });
                totalEl.innerText = total.toFixed(2) + " â‚º";
            }
        }

        function openNewProductModal(code) {
            document.getElementById('new-product-modal').classList.remove('hidden');
            document.getElementById('modal-code').value = code;
            document.getElementById('modal-name').value = "";
            document.getElementById('modal-price').value = "";
            document.getElementById('modal-stock').value = "";
        }
        function closeNewProductModal() { document.getElementById('new-product-modal').classList.add('hidden'); }
        
        async function saveNewProduct() {
            const code = document.getElementById('modal-code').value;
            const name = document.getElementById('modal-name').value;
            const price = parseFloat(document.getElementById('modal-price').value);
            const stock = parseInt(document.getElementById('modal-stock').value);
            if(!name || isNaN(price)) return alert("Bilgileri girin!");
            productDB[code] = { name, price, stock: stock || 0 };
            closeNewProductModal();
            saveToGithub(CONFIG.FILE_STOK, productDB, shaStok, "Yeni: " + name).then(() => loadStockData());
            addToCart(code);
        }

        function copyMySales() {
            if(cart.length === 0) return alert("Liste boÅŸ!");
            let text = `ðŸ“… SATIÅž LÄ°STESÄ°\nðŸ‘¤ ${currentUser}\n------------------\n`;
            let total = 0;
            cart.forEach(item => { text += `${item.name} | ${item.price} â‚º\n`; total += parseFloat(item.price); });
            text += `------------------\nTOPLAM: ${total.toFixed(2)} â‚º`;
            navigator.clipboard.writeText(text).then(() => alert("KopyalandÄ±!"));
        }

        async function completeSale() {
            const btn = document.getElementById('finish-btn');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>'; btn.disabled = true;
            try {
                let archiveData = []; let archiveSha = null;
                try {
                    const res = await fetch(`https://api.github.com/repos/${CONFIG.USER}/${CONFIG.REPO}/contents/${CONFIG.FILE_MUHASEBE}`, { headers: {'Authorization':`token ${CONFIG.TOKEN}`} });
                    if(res.ok) {
                        const d = await res.json(); archiveSha = d.sha;
                        archiveData = JSON.parse(decodeURIComponent(escape(window.atob(d.content))));
                    }
                } catch(e){}

                const fullDate = new Date().toLocaleString('tr-TR');
                cart.forEach(item => {
                    if(productDB[item.code]) productDB[item.code].stock -= 1;
                    archiveData.push({ ...item, fullDate });
                });

                await saveToGithub(CONFIG.FILE_STOK, productDB, shaStok, "Stok Dusumu");
                await saveToGithub(CONFIG.FILE_MUHASEBE, archiveData, archiveSha, "Satis Kaydi");
                cart = []; renderCart(); loadStockData();
                btn.innerHTML = 'SATIÅžI TAMAMLA'; showStatus("SatÄ±ÅŸ TamamlandÄ±!", false);
            } catch(e) { alert("Hata: " + e); btn.disabled = false; btn.innerText = "TEKRAR DENE"; }
        }

        async function openAccounting() {
            document.getElementById('accounting-modal').classList.remove('hidden');
            const tb = document.getElementById('accounting-body'); tb.innerHTML = '<tr><td colspan="4" class="p-4 text-center">YÃ¼kleniyor...</td></tr>';
            try {
                const res = await fetch(`https://api.github.com/repos/${CONFIG.USER}/${CONFIG.REPO}/contents/${CONFIG.FILE_MUHASEBE}`, { headers: {'Authorization':`token ${CONFIG.TOKEN}`} });
                const d = await res.json();
                const sales = JSON.parse(decodeURIComponent(escape(window.atob(d.content))));
                tb.innerHTML = "";
                sales.reverse().forEach(s => {
                    tb.innerHTML += `<tr class="border-b border-slate-700 hover:bg-slate-700"><td class="py-3 text-xs text-slate-400">${s.fullDate ? s.fullDate.split(' ')[1] : s.date}</td><td class="font-bold">${s.staff}</td><td>${s.name}</td><td class="text-right text-emerald-400 font-bold">${parseFloat(s.price).toFixed(2)}</td></tr>`;
                });
            } catch { tb.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-slate-500">KayÄ±t yok.</td></tr>'; }
        }

        async function resetDailyData() {
            if(!confirm("âš ï¸ GÃœN SONU Ä°ÅžLEMÄ°\nTÃ¼m satÄ±ÅŸ verileri silinecek. OnaylÄ±yor musun?")) return;
            try {
                const res = await fetch(`https://api.github.com/repos/${CONFIG.USER}/${CONFIG.REPO}/contents/${CONFIG.FILE_MUHASEBE}`, { headers: {'Authorization':`token ${CONFIG.TOKEN}`} });
                const d = await res.json();
                await saveToGithub(CONFIG.FILE_MUHASEBE, [], d.sha, "GUN SONU SIFIRLAMA");
                alert("Kasa sÄ±fÄ±rlandÄ±."); closeAccounting();
            } catch(e) { alert("SÄ±fÄ±rlama hatasÄ±: " + e); }
        }

        function closeAccounting() { document.getElementById('accounting-modal').classList.add('hidden'); }
        function printReport() { window.print(); }
        function copyReport() { navigator.clipboard.writeText(document.getElementById('accounting-table-area').innerText).then(()=>alert("KopyalandÄ±")); }
        
        async function saveToGithub(file, contentObj, sha, msg) {
            const content = window.btoa(unescape(encodeURIComponent(JSON.stringify(contentObj, null, 2))));
            const body = { message: msg, content }; if(sha) body.sha = sha;
            await fetch(`https://api.github.com/repos/${CONFIG.USER}/${CONFIG.REPO}/contents/${file}`, {
                method: 'PUT', headers: {'Authorization': `token ${CONFIG.TOKEN}`, 'Content-Type': 'application/json'}, body: JSON.stringify(body)
            });
        }

        function showStatus(msg, isErr) {
            const el = document.getElementById('status-box'); el.querySelector('span').innerText=msg;
            el.style.backgroundColor = isErr ? "#e11d48" : "#059669";
            el.style.opacity="1"; el.style.transform="translate(-50%,0)";
            setTimeout(()=>{el.style.opacity="0"; el.style.transform="translate(-50%,-20px)"}, 2000);
        }
    </script>
</body>
</html>
