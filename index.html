<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HIZLI QR V16 - KARE İÇİ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        body { background-color: #0f172a; color: white; font-family: sans-serif; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }
        .hidden { display: none !important; }

        /* --- KARE KAMERA KUTUSU TASARIMI --- */
        #camera-wrapper {
            position: relative;
            width: 300px;  /* Kare Genişliği */
            height: 300px; /* Kare Yüksekliği */
            margin: 0 auto; /* Ortala */
            border-radius: 24px;
            overflow: hidden; /* Taşanı gizle */
            border: 4px solid #10b981; /* Yeşil Çerçeve */
            background-color: #000;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
        }

        /* Video elementini kutuya zorla sığdır */
        #reader { width: 100%; height: 100%; border: none !important; }
        #reader video { 
            object-fit: cover !important; /* Görüntüyü kareye yay */
            width: 100% !important; 
            height: 100% !important; 
            border-radius: 20px !important;
        }

        /* Kütüphanenin kendi çirkin çizgilerini gizle */
        #reader__scan_region { display: none !important; }
        #reader__dashboard_section_csr span { display: none !important; }
    </style>
</head>
<body>

    <div id="login-screen" class="fixed inset-0 bg-slate-900 z-[9999] flex flex-col items-center justify-center p-6">
        <div class="bg-slate-800 p-8 rounded-2xl border border-slate-700 w-full max-w-sm text-center">
            <h2 class="text-2xl font-bold text-white mb-6">QR POS GİRİŞ</h2>
            <input type="text" id="staff-name" placeholder="KULLANICI ADI" class="w-full bg-slate-950 text-white text-center text-xl font-bold py-4 rounded-xl border-2 border-slate-600 outline-none mb-4 uppercase">
            <button onclick="login()" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-xl text-lg">GİRİŞ</button>
        </div>
    </div>

    <div id="app-content" class="flex flex-col h-full hidden">
        
        <header class="bg-slate-800 p-3 flex justify-between items-center shrink-0 border-b border-slate-700">
            <div>
                <h1 class="font-bold text-gray-100 text-sm">SATIŞ EKRANI</h1>
                <div id="active-staff-display" class="text-[10px] text-emerald-400">...</div>
            </div>
             <button onclick="openAccounting()" class="bg-slate-700 px-3 py-2 rounded-lg text-xs font-bold text-white border border-slate-600">
                MUHASEBE
            </button>
        </header>

        <div id="status-box" class="absolute top-20 left-1/2 transform -translate-x-1/2 bg-emerald-600 px-6 py-3 rounded-full text-sm font-bold text-white z-50 transition-all duration-300 opacity-0 pointer-events-none shadow-xl">
            İşlem Başarılı
        </div>

        <div class="flex-1 overflow-y-auto bg-slate-900 p-4" id="sales-area">
            
            <div id="camera-section" class="hidden mb-6 flex flex-col items-center animate-fade-in">
                <div class="text-slate-400 text-xs mb-2 font-bold tracking-widest">KODU KAREYE TUTUN</div>
                
                <div id="camera-wrapper">
                    <div id="reader"></div>
                </div>

                <button onclick="stopCamera()" class="mt-4 bg-slate-800 text-slate-300 px-6 py-2 rounded-full text-sm font-bold border border-slate-700">
                    İPTAL ET / KAPAT
                </button>
            </div>

            <div id="empty-state" class="flex flex-col items-center justify-center h-48 text-slate-600 opacity-50">
                <i class="fa-solid fa-qrcode text-6xl mb-4"></i>
                <p>QR Okutun...</p>
            </div>

            <div id="cart-list" class="space-y-2 hidden"></div>
        </div>

        <div class="bg-slate-800 p-4 rounded-t-3xl border-t border-slate-700 shrink-0 shadow-2xl">
            
            <div class="flex gap-2 mb-4">
                <button onclick="startCamera()" id="cam-btn" class="flex-1 bg-indigo-600 text-white py-5 rounded-xl text-xl font-bold shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-transform">
                    <i class="fa-solid fa-camera"></i> KAMERAYI AÇ
                </button>
                
                <button onclick="toggleManual()" class="bg-slate-700 text-white w-20 rounded-xl text-2xl border border-slate-600 active:scale-95">
                    <i class="fa-solid fa-keyboard"></i>
                </button>
            </div>

            <div id="manual-box" class="hidden flex gap-2 mb-4">
                <input type="text" id="manual-input" placeholder="Manuel Kod..." class="flex-1 bg-slate-950 text-white px-4 rounded-xl border border-slate-600 outline-none h-12">
                <button onclick="manualAdd()" class="bg-emerald-600 text-white px-4 rounded-xl font-bold">EKLE</button>
            </div>

            <div class="flex justify-between items-center border-t border-slate-700 pt-3">
                <div>
                    <div class="text-xs text-slate-400">TOPLAM</div>
                    <div id="cart-total" class="text-3xl font-bold text-emerald-400">0.00 ₺</div>
                </div>
                <div class="flex gap-2">
                    <button onclick="copySales()" class="bg-slate-600 text-white px-3 py-3 rounded-xl font-bold text-sm">LİSTE</button>
                    <button onclick="completeSale()" id="finish-btn" class="bg-emerald-600 text-white px-5 py-3 rounded-xl font-bold disabled:opacity-50 disabled:bg-slate-700" disabled>BİTİR</button>
                </div>
            </div>
        </div>
    </div>

    <div id="new-product-modal" class="fixed inset-0 bg-black/90 z-[100] hidden flex flex-col justify-center p-6 backdrop-blur-sm">
        <div class="bg-slate-800 p-6 rounded-2xl border border-slate-600 shadow-2xl">
            <h2 class="text-xl font-bold text-white mb-4 text-center">YENİ ÜRÜN</h2>
            <div class="space-y-3">
                <input type="text" id="modal-code" class="w-full bg-slate-900 text-emerald-400 p-3 rounded-xl font-mono text-center text-sm" readonly>
                <input type="text" id="modal-name" class="w-full bg-slate-950 text-white p-4 rounded-xl border border-slate-600 font-bold text-lg" placeholder="Ürün Adı">
                <div class="grid grid-cols-2 gap-3">
                    <input type="number" id="modal-price" class="w-full bg-slate-950 text-emerald-400 p-4 rounded-xl border border-slate-600 font-bold text-lg" placeholder="Fiyat">
                    <input type="number" id="modal-stock" class="w-full bg-slate-950 text-orange-400 p-4 rounded-xl border border-slate-600 font-bold text-lg" placeholder="Stok">
                </div>
            </div>
            <button onclick="saveNewProduct()" class="w-full mt-6 bg-emerald-600 text-white py-4 rounded-xl font-bold text-lg hover:bg-emerald-500">KAYDET</button>
            <button onclick="closeModal()" class="w-full mt-2 py-3 text-slate-400 text-sm">İptal</button>
        </div>
    </div>

    <div id="accounting-modal" class="fixed inset-0 bg-slate-900 z-[100] hidden flex flex-col p-4">
        <div class="flex justify-between items-center mb-4">
            <h2 class="font-bold text-white text-xl">Rapor</h2>
            <button onclick="closeAccounting()" class="bg-slate-700 w-10 h-10 rounded-full text-white">X</button>
        </div>
        <div class="flex-1 overflow-auto bg-slate-800 rounded-xl p-2" id="acc-body"></div>
        <div class="mt-4 flex gap-2">
            <button onclick="resetDaily()" class="flex-1 bg-rose-700 text-white py-4 rounded-xl font-bold">GÜN SONU SİL</button>
        </div>
    </div>

    <script>
        // ============================================
        // ⚠️ TOKEN
        // ============================================
        const token_part_1 = "ghp_"; 
        const token_part_2 = "cXub3CuFhcdHtGbKgyQkvCKj57AUos0kNIIW"; 

        const CONFIG = {
            USER: "fthlabz", 
            REPO: "Stok-takip-genel", 
            FILE_STOK: "genel_stok.json",
            FILE_MUHASEBE: "muhasebe_arsiv.json",
            TOKEN: token_part_1 + token_part_2
        };
        // ============================================

        let productDB = {}; 
        let cart = []; 
        let currentUser = ""; 
        let html5QrCode; 
        let shaStok = null;

        function login() {
            const val = document.getElementById('staff-name').value.trim().toUpperCase();
            if(!val) return alert("İsim giriniz!");
            currentUser = val;
            document.getElementById('active-staff-display').innerText = currentUser;
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-content').classList.remove('hidden');
            loadData();
        }

        async function loadData() {
            try {
                const url = `https://api.github.com/repos/${CONFIG.USER}/${CONFIG.REPO}/contents/${CONFIG.FILE_STOK}`;
                const res = await fetch(url, { headers: { 'Authorization': `token ${CONFIG.TOKEN}` }, cache: "no-store" });
                if(res.ok) {
                    const data = await res.json();
                    shaStok = data.sha;
                    productDB = JSON.parse(decodeURIComponent(escape(window.atob(data.content))));
                } else if(res.status === 404) {
                    productDB = {}; initFile(CONFIG.FILE_STOK, {});
                } else {
                    alert("Veri çekilemedi.");
                }
            } catch(e) { console.error(e); }
        }

        // --- KARE EKRAN KAMERA SİSTEMİ ---
        function startCamera() {
            // Arayüz düzenlemeleri
            document.getElementById('camera-section').classList.remove('hidden'); // Kareyi göster
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('manual-box').classList.add('hidden');
            document.getElementById('cam-btn').classList.add('hidden'); // Butonu gizle

            html5QrCode = new Html5Qrcode("reader");

            const config = { 
                fps: 10, 
                // ÖNEMLİ: qrbox'ı tam 300 yapıyorum ki bütün ekran tarasın, çizgi olmasın
                qrbox: { width: 300, height: 300 }, 
                aspectRatio: 1.0, 
                disableFlip: false 
            };
            
            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
            .catch(err => {
                alert("Kamera izni verin!");
                stopCamera();
            });
        }

        function onScanSuccess(decodedText, decodedResult) {
            // Başarılı okumada bip sesi efekti eklenebilir
            stopCamera(); 
            processCode(decodedText);
        }

        function stopCamera() {
            if(html5QrCode) {
                html5QrCode.stop().then(() => {
                    html5QrCode.clear();
                    closeCameraUI();
                }).catch(err => {
                    console.log("Stop hatası", err);
                    closeCameraUI();
                });
            } else {
                closeCameraUI();
            }
        }

        function closeCameraUI() {
            document.getElementById('camera-section').classList.add('hidden');
            document.getElementById('cam-btn').classList.remove('hidden');
            if(cart.length === 0) document.getElementById('empty-state').classList.remove('hidden');
        }

        function processCode(code) {
            if(code.includes("id=")) code = code.split("id=")[1];
            
            if(productDB[code]) {
                addToCart(code);
            } else {
                openModal(code);
            }
        }

        // --- SEPET İŞLEMLERİ ---
        function addToCart(code) {
            const p = productDB[code];
            cart.push({code, name: p.name, price: p.price, date: new Date().toLocaleTimeString('tr-TR')});
            renderCart();
            showStatus(p.name + " Eklendi");
        }

        function renderCart() {
            const list = document.getElementById('cart-list');
            const totalEl = document.getElementById('cart-total');
            list.innerHTML = ""; let total = 0;

            if(cart.length > 0) {
                document.getElementById('empty-state').classList.add('hidden');
                document.getElementById('cart-list').classList.remove('hidden');
                document.getElementById('finish-btn').disabled = false;
            }

            [...cart].reverse().forEach((item, i) => {
                total += parseFloat(item.price);
                list.innerHTML += `<div class="bg-slate-800 p-3 rounded-xl border border-slate-700 flex justify-between items-center mb-1"><div><div class="text-[10px] text-slate-400">${item.date}</div><div class="font-bold">${item.name}</div></div><div class="text-right"><div class="text-emerald-400 font-bold">${item.price} ₺</div><button onclick="cart.splice(${cart.length-1-i},1);renderCart()" class="text-rose-500 text-xs p-1">SİL</button></div></div>`;
            });
            totalEl.innerText = total.toFixed(2) + " ₺";
        }

        // --- YENİ ÜRÜN ---
        function openModal(code) {
            document.getElementById('new-product-modal').classList.remove('hidden');
            document.getElementById('modal-code').value = code;
            document.getElementById('modal-name').value = "";
            document.getElementById('modal-price').value = "";
            document.getElementById('modal-stock').value = "";
            document.getElementById('modal-name').focus();
        }
        function closeModal() { document.getElementById('new-product-modal').classList.add('hidden'); }
        
        async function saveNewProduct() {
            const code = document.getElementById('modal-code').value;
            const name = document.getElementById('modal-name').value;
            const price = parseFloat(document.getElementById('modal-price').value);
            const stock = parseInt(document.getElementById('modal-stock').value);
            if(!name || isNaN(price)) return alert("Eksik bilgi!");
            productDB[code] = { name, price, stock: stock || 0 };
            closeModal();
            showStatus("Kaydediliyor...");
            saveGithub(CONFIG.FILE_STOK, productDB, shaStok, "Yeni: "+name).then(()=>loadData());
            addToCart(code);
        }

        // --- TAMAMLAMA ---
        async function completeSale() {
            const btn = document.getElementById('finish-btn');
            const oldT = btn.innerText; btn.innerText = "⏳"; btn.disabled = true;
            try {
                let arc = []; let arcSha = null;
                try {
                    const r = await fetch(`https://api.github.com/repos/${CONFIG.USER}/${CONFIG.REPO}/contents/${CONFIG.FILE_MUHASEBE}`, {headers:{'Authorization':`token ${CONFIG.TOKEN}`}});
                    if(r.ok) { const d=await r.json(); arcSha=d.sha; arc=JSON.parse(decodeURIComponent(escape(window.atob(d.content)))); }
                } catch(e){}
                cart.forEach(c => { if(productDB[c.code]) productDB[c.code].stock -= 1; arc.push({...c, staff: currentUser, fullDate: new Date().toLocaleString()}); });
                await saveGithub(CONFIG.FILE_STOK, productDB, shaStok, "Satis");
                await saveGithub(CONFIG.FILE_MUHASEBE, arc, arcSha, "Satis");
                cart = []; renderCart(); btn.innerText = oldT; btn.disabled = true;
                showStatus("✅ Satış Tamam");
            } catch(e) { alert("Hata:"+e); btn.innerText=oldT; btn.disabled=false; }
        }

        // --- DİĞER ---
        function toggleManual() {
            const box = document.getElementById('manual-box');
            box.classList.toggle('hidden');
            if(!box.classList.contains('hidden')) document.getElementById('manual-input').focus();
        }
        function manualAdd() {
            const val = document.getElementById('manual-input').value;
            if(val) processCode(val);
            document.getElementById('manual-input').value="";
        }
        function copySales() {
            let t = `SATIŞLAR (${currentUser})\n`; cart.forEach(c=>t+=`${c.name} ${c.price}\n`);
            navigator.clipboard.writeText(t).then(()=>showStatus("Kopyalandı"));
        }
        async function openAccounting() {
            document.getElementById('accounting-modal').classList.remove('hidden');
            const el = document.getElementById('acc-body'); el.innerHTML = "Yükleniyor...";
            try {
                const r = await fetch(`https://api.github.com/repos/${CONFIG.USER}/${CONFIG.REPO}/contents/${CONFIG.FILE_MUHASEBE}`, {headers:{'Authorization':`token ${CONFIG.TOKEN}`}});
                const d = await r.json();
                const list = JSON.parse(decodeURIComponent(escape(window.atob(d.content))));
                el.innerHTML = ""; let tot = 0;
                list.reverse().forEach(x => { tot+=parseFloat(x.price); el.innerHTML += `<div class="border-b border-slate-700 p-2 flex justify-between"><span class="text-xs text-slate-400">${x.fullDate}</span> <span>${x.name}</span> <span class="text-emerald-400 font-bold">${x.price} ₺</span></div>`; });
                el.innerHTML = `<div class="bg-slate-700 p-2 text-center font-bold mb-2 rounded sticky top-0">TOPLAM: ${tot.toFixed(2)} TL</div>` + el.innerHTML;
            } catch { el.innerHTML = "Kayıt yok."; }
        }
        function closeAccounting() { document.getElementById('accounting-modal').classList.add('hidden'); }
        async function resetDaily() {
            if(!confirm("Emin misin?")) return;
            const r = await fetch(`https://api.github.com/repos/${CONFIG.USER}/${CONFIG.REPO}/contents/${CONFIG.FILE_MUHASEBE}`, {headers:{'Authorization':`token ${CONFIG.TOKEN}`}});
            const d = await r.json();
            await saveGithub(CONFIG.FILE_MUHASEBE, [], d.sha, "Reset");
            showStatus("Sıfırlandı"); closeAccounting();
        }

        async function saveGithub(file, content, sha, msg) {
            const body = { message: msg, content: window.btoa(unescape(encodeURIComponent(JSON.stringify(content, null, 2)))) };
            if(sha) body.sha = sha;
            await fetch(`https://api.github.com/repos/${CONFIG.USER}/${CONFIG.REPO}/contents/${file}`, {
                method: 'PUT', headers: {'Authorization': `token ${CONFIG.TOKEN}`, 'Content-Type': 'application/json'}, body: JSON.stringify(body)
            });
        }
        async function initFile(file, content) { await saveGithub(file, content, null, "Init"); }

        function showStatus(msg) {
            const el = document.getElementById('status-box'); el.innerText=msg; el.style.opacity="1"; el.style.transform="translate(-50%,0)";
            setTimeout(()=>{el.style.opacity="0"; el.style.transform="translate(-50%,-20px)"}, 2000);
        }
    </script>
</body>
</html>
